name: Release

on:
  push:
    tags:
      - 'admin-v*'

defaults:
  run:
    working-directory: admin

permissions:
  contents: write
  packages: write

env:
  NODE_VERSION: '20'

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/admin-v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Release version: ${VERSION}"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: admin/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run lint
        run: npm run lint

      - name: Run type check
        run: npm run typecheck

      - name: Build application
        run: npm run build
        env:
          NEXT_TELEMETRY_DISABLED: 1
          NEXTAUTH_SECRET: dummy-secret-for-build
          NEXTAUTH_URL: http://localhost:3000
          NEXT_PUBLIC_API_URL: http://localhost:8000/api/v1

  create-release:
    name: Create GitHub Release
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        uses: orhun/git-cliff-action@v3
        with:
          config: admin/.github/cliff.toml
          args: --current --strip header
        env:
          OUTPUT: CHANGELOG.md

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Admin Panel v${{ needs.validate.outputs.version }}
          body: |
            ## Admin Panel Release v${{ needs.validate.outputs.version }}

            ### Changes
            ${{ steps.changelog.outputs.content }}

            ### Deployment
            This release can be deployed using:
            ```bash
            # Staging
            gh workflow run "Deploy Admin Panel" -f environment=staging -f image_tag=admin-v${{ needs.validate.outputs.version }}

            # Production
            gh workflow run "Deploy Admin Panel" -f environment=prod -f image_tag=admin-v${{ needs.validate.outputs.version }}
            ```
          draft: false
          prerelease: ${{ contains(needs.validate.outputs.version, '-') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: Notify
    needs: [validate, create-release]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Create summary
        run: |
          if [ "${{ needs.create-release.result }}" == "success" ]; then
            echo "## Release Created Successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Version:** v${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The release is ready for deployment." >> $GITHUB_STEP_SUMMARY
          else
            echo "## Release Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
          fi
